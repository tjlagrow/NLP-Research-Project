repgenHMM a dynamic programming tool to infer the rules of immune receptor
generation from sequence data
Yuval Elhanati1 Quentin Marcou1 Thierry Mora2 and Aleksandra M Walczak1
1Laboratoire de physique theorique UMR8549 CNRS and Ecole normale superieure 24 rue Lhomond 75005 Paris France
2Laboratoire de physique statistique UMR8550 CNRS and Ecole normale superieure 24 rue Lhomond 75005 Paris France
Dated November 3 2015
The diversity of the immune repertoire is initially generated by random rearrangements of the
receptor gene during early T and B cell development Rearrangement scenarios are composed of
random events  choices of gene templates base pair deletions and insertions  described by prob-
ability distributions Not all scenarios are equally likely and the same receptor sequence may be
obtained in several dierent ways Quantifying the distribution of these rearrangements is an essen-
tial baseline for studying the immune system diversity Inferring the properties of the distributions
from receptor sequences is a computationally hard problem requiring enumerating every possible
scenario for every sampled receptor sequence We present a Hidden Markov model which accounts
for all plausible scenarios that can generate the receptor sequences We developed and implemented
a method based on the Baum-Welch algorithm that can eciently infer the parameters for the
dierent events of the rearrangement process We tested our software tool on sequence data for
both the alpha and beta chains of the T cell receptor To test the validity of our algorithm we
also generated synthetic sequences produced by a known model and conrmed that its parameters
could be accurately inferred back from the sequences The inferred model can be used to generate
synthetic sequences to calculate the probability of generation of any receptor sequence as well as
the theoretical diversity of the repertoire We estimate this diversity to be  1023 for human T
cells The model gives a baseline to investigate the selection and dynamics of immune repertoires
Source code and sample sequence les are available at httpsbitbucketorgyuvalel
repgenhmmdownloads
INTRODUCTION
The ability of the adaptive immune system to identify
a wide range of threats rests upon the diversity of its
lymphocyte receptors which together make up the im-
mune repertoire Each such receptor can bind specically
to antigenic molecules and initiates an immune response
against the threat
T cell receptors TCR are composed of two protein
chains called alpha and beta B cell receptors BCR
share a very similar structure with a light chain and
heavy chain playing the same role Each chain is pro-
duced according to the same process of VDJ rear-
rangement
In each new cell and for each of the two
chains two germline segments for alpha chains V and
J genes or three segments for beta chains V D and
J genes are assembled together to form the recombined
gene coding for the chain In addition at the junctions
where the segments are joined the ends of the segments
are trimmed and random nucleotides are inserted see
Fig 1a for a diagram describing the alpha chain rear-
rangement process This process creates a large initial
diversity of possible receptors which are later selected
according to their recognition functionality An impor-
tant property of this process is that it is redundant as
many dierent VDJ rearrangements may lead to the ex-
act same sequence It is thus impossible to unambigously
reconstruct the scenario from the sequence alone a prob-
lem that is aggravated by sequencing errors
The rearrangement process is random as is each of
the elements composing it  choice of germline segments
number of deleted nucleotides number and identity of
insertions
Since the rearrangement process is the basis of reper-
toire diversity it is important to study its distribution
quantitatively With recent advances in high through-
put sequencing there is a growing body of data on
repertoires for both T and B cells in a variety of sit-
uations Using large sequence datasets of rearranged
non-productive genes the probability distribution of re-
arrangement events in human TCR beta chain and BCR
heavy chains could be inferred using statistical methods
gaining important insights into the random processes un-
derlying repertoire diversity 1 2 However these stud-
ies are based on a brute force approach which enumer-
ates every possible rearrangement scenario for each ob-
served sequence This is a very computationally costly
procedure which is unrealistic for very large datasets
In this report we present a dynamic programming ap-
proach to learn the distribution of rearrangement sce-
narios from large numbers of non-productive sequences
in an ecient way This approach is based on a Hid-
den Markov Models HMM formulation of the problem
and learns its parameters using a modied Baum-Welch
BW algorithm to avoid the full enumerations of all sce-
narios Many studies have described algorithms designed
to process large numbers of rearranged TCR or BCR
genes and extract the template VDJ genes of the re-
arrangement 317 These tools process each sequence
separately to obtain the best but often incorrect align-
ment to a VDJ combination sometimes using dynamic
programming or HMM 13 14 16 17 and assume an
implicit ad hoc prior on rearrangements By contrast
our algorithm explores all plausible alignments for each
sequence from data to learn accurately the distribution
of rearrangement events
Once the model of rearrangement has been learned
by our procedure the entire distribution of possible se-
quences and their probabilities is accessible Our algo-
rithm can calculate the probability of any sampled se-
quence even if it is not part of the data used to learn the
model and it can generate arbitrary numbers of synthetic
sequences with the exact same statistics as the data It
can also calculate the entropy of the rearrangement pro-
cess  a classical measure of sequence diversity This en-
ables us to further our understanding of the generation
process quantify the baseline state of the immune sys-
tem and evaluate subsequent processes such as somatic
selection Finally our work produces insights not just
on the data sequences but on the underlying biological
processes
II METHODS
A Model
The algorithm assumes a general form for the proba-
bility distribution of possible rearrangements and then
nds the parameters of that distribution that best t the
sequence data 1 2 For simplicity we rst describe the
model for the alpha chain of TCRs which also applies
for the light chain of BCRs The case of the beta and
heavy chains will be described later
The model species probability distributions for each
of the rearrangement events V and J gene choices
P V J number of deletions conditioned on the gene
being deleted P delV V  and P delJJ and inser-
tion length and nucleotide identity P ins
gether these distributions form the parameter set  
P V J P delV V     The probability of a given re-
arrangement scenario r  V J delV delJ ins is then
given by
Prearrr  P V JP delV V P delJJP ins
The specic form of the model assumes some depen-
In the above formula for
dencies between the events
instance the probabilities of each V and J choice can be
dependent but the insertion is independent from both
while the deletion probabilities are dependent only on the
identity of the gene being deleted The model choice is
done based on biological knowledge and has been val-
idated by previous work in the case of the beta chain
To avoid confounding factors related to thymic or pe-
ripheral selection the inference of the parameters is per-
formed on non-productive genes During the matura-
tion of cells some rearrangement events produce non-
productive genes that are either out of frame having the
wrong combination of insertions and deletions or contain
a stop codon
cid80
When this happens the other chromosome in the
same cell may undergo a second successful rearrange-
ment event ensuring the survival of the cell Yet the
non-productive rearrangements remain and are part of
the sequence dataset Since these sequences have no ef-
fect on the cell in which they reside they have not been
selected Studying their statistics is thus equivalent to
studying the generation process itself with no selection
While the model species the distribution over rear-
rangement scenarios the data consists of recombined se-
quences denoted by s which can be the result of dif-
ferent scenarios r The recombination events are hidden
variables and the likelihood of a sequence is the sum of
the probabilities of all scenarios leading to it P s 
rs Prearrr The likelihood of the sequence dataset
cannot easily be maximised with respect to the model
parameters To overcome this problem the Expectation-
Maximisation EM algorithm can be used to maximise
the likelihood in an iterative manner
In each iteration new model parameters cid48 are cho-
sen to increase the likelihood until the maximum is ob-
tained In the expectation step the log-likelihood of hid-
cid80
den rearrangements is averaged over their posterior dis-
tribution under the current model  to form Qcid48 
r P rsa  log Parranrcid48 where the sum on
a runs over the n sequences s1 s2     sn in the
dataset The maximisation step consists of maximising
Qcid48 over cid48 to obtain the new parameter set Be-
cause of the simple factorised form of Eq 1 this second
step is equivalent to calculating the frequency of each
rearrangement event under the posterior P rsa  
P r saP sa For example P V J is updated
according to
cid80n
ncid88
cid88
P cid48V J 
P rsa 
where the sum on r  V J runs over scenarios with gene
choices V and J Similar update rules are used for
the other model parameters P delV V  P delJJ and
P ins The sums over possible scenarios for each data
sequence sa are computationally heavy To make them
easier we now introduce an equivalent HMM formulation
of the model
B HMM formulation
The almost linear structure of rearrangements allows
for their description as a Markov chain Hidden Markov
models lend themselves to the much more ecient
forward-backward algorithm for marginal estimations
and in combination with Expectation-Maximisation the
Baum-Welch BW algorithm for parameter inference
In general however the V and J gene choices may be cor-
related in their joint distribution P V J breaking the
Markovian nature of the rearrangement statistics To
preserve the Markovian structure we built a separate
HMM for each choice of the pair of germline genes V J
and use the forward-backward algorithm to calculate the
marginals of the other rearrangement events conditioned
on that choice These conditional marginals will then be
combined for all V J to perform the maximisation step
For a chosen V J pair a Hidden Markov Model
HMM is constructed to yield the recombined sequences
in accordance with Eq 1 Fig 1b shows a diagram of the
model The model proceeds through a sequence of hid-
den states S which emit nucleotides si for i  1     L
where L is the sequence length thus producing the entire
sequence s  s1     sL
We distinguish between two types of emitting states
represented by circles in Fig 1b First genomic states
or V and J states are dened for each position on
the genomic templates V and J and are denoted by
V1 V2  Vend for V states and likewise for J states
These states emit the nucleotide encoded in the genomic
template at the corresponding position or with a small
error probability perr a dierent nucleotide These non-
templated emissions can be caused by sequencing errors
B cell hypermutations or uncharted alleles Second in-
sertions states emit random nontemplated nucleotides
according to a distribution I1 corresponds to the rst
inserted nucleotide I2 to the second one and so on In
addition we introduce two ghost states G1 and G2 rep-
resented by rectangles in Fig 1b between the V and I
states and between the I and J states These states do
not emit nucleotides and their sole function is to reduce
the number of possible transitions between states by iso-
lating the state types thus easing computations
Each sequence is the result of a stochastic path through
a series of states dened in Fig 1b and their random
emissions To illustrate how the HMM operates we fol-
low a possible path leading to the production of a light
chain for a given choice of V and J The chain starts
from the V1 state going along the V gene and emitting
nucleotides from the gene Most of these nucleotides are
those of the genomic template up to the error rate At
some point possibly before all V states are exhausted to
account for potential V deletions the process transitions
to the rst ghost state G1 From G1 the process goes to
the rst insertion state I1 or directly to G2 if there are
no insertions Each insertion state emits a nucleotide
After a certain number of insertions the process moves
to the second ghost state G2 and then on to a J state
but not necessarily J1 to account for J deletions Fi-
nally the process will continue along the J states until
Jend completing the sequence
The HMM is dened by two sets of parameters which
map directly onto P V J The rst set of parame-
ters is the transition probabilities MSScid48 between any two
states S and Scid48 connected by an arrow in Fig 1 The
transition rates between V states and G1 and between
G2 and J states can be mapped onto the deletion pro-
FIG 1 a Schematic description of the rearrangement pro-
cess for the light and alpha chains Random V and J genes are
chosen from the genome A random number of nucleotides are
trimmed from their facing ends These ends are then joined
with an insertion segment of variable length and composition
b Markov model for this rearrangement process when the
V and J gene choices are known By progressing one path fol-
lowing the arrows the model produces a rearranged receptor
gene Each state denoted by a circle emits a nucleotide V
and J states each emit one nucleotide from the chosen tem-
plate up to an error rate Emissions from the I states are
drawn from an specied distribution The states represented
by squares are nonemitting ghost states The arrows repre-
sent the allowed transitions some of them are marked on the
diagram with MSScid48  The probabilities of the transitions and
emissions are the parameters of the HMM as described in the
main text
les of the V and J genes respectively and the transition
rates between the I states and G2 can be mapped onto
the distribution of the number of insertions The tran-
sition matrix MSScid48 is very sparse thanks in part to the
ghost states
allowing for quick computations as we will see below
The second set of parameters are the emission probabil-
ities ESs that nucleotide s is emitted by state S If S
is a genomic V or J state then ESs  1  perr if s
is the template nucleotide which we denote by S and
V1V2J1J2VJIVJMV1V2MVmG1MG1G2MIeG2MG2J2V1V2VmVendStartG1I1I2IendG2J1J2JendabIperr3 otherwise
If S is an insertion state it is given
by a distribution EI s which we assume to be common
to all insertion states ie
independent of the order of
insertions
an oset between the state index and the corresponding
position on the sequence Thus V states in the n posi-
tion correspond to position n in the sequence I states to
position n  1 in the sequence and J states to position
n  2
C A modied Baum-Welch algorithm
The Baum-Welch BW algorithm nds the param-
eters for a given HMM which maximise the likelihood
of producing the observed sequences 18 19
It is an
instance of the EM algorithm where the maximisation
step is performed using the forward-backward algorithm
Since our HMM is conditioned on the knowledge of the
V J pair which is itself a hidden variable BW cannot
be applied without modication However we can still
use the forward-backward algorithm to calculate the pos-
terior probabilities of rearrangement events for a given
sequence s  s1     sL and a given putative V J
choice and combine these probabilities at the end
The forward pass of the forward-backward algorithm
calculates iS the joint probability of the model being
in a specic state S and emitting the sequence up to the
ith nucleotide s1  si The backwards pass does the
same for iS the conditional probability of emitting
the sequence upstream from position i given that the
state in this position is S
iS  P s1  si SV J
iS  P si1  sLS V J
These probabilities are calculated using the following re-
cursion relations
cid88
Scid48
iS  ESsi
MSScid48i1Scid48
iS 
EScid48si1MScid48Si1Scid48
cid88
Scid48
Since our transition matrix MSScid48 is very sparse the sum
over Scid48 has few terms and can be calculated eciently
Having obtained these forward and backward probabil-
ities for a sequence given a choice of V and J genes
the posterior marginal probabilities for each transition
S  Scid48 as well as the posterior emission probabilities
are calculated as
P S  Scid48V J s  cid88
P errV J s  cid88
PinssV J s  cid88
cid88
cid88
SVJ
iSMScid48SEScid48si1i1Scid48
iSnS1  S si
Once the posterior marginals have been evaluated for
each data sequence and for each putative choice of V and
J we can combine them to obtain the update equations
of our modied Baum-Welch algorithm
ncid88
ncid88
ncid88
cid88
cid88
cid88
MScid48S  1
perr  1
ESs  1
P V JsaP S  Scid48V J sa
P V JsaP errV J sa
P V JsaPinssV J sa
where the posterior probability P V Jsa is calcu-
lated using Bayes rule  P saV JP V J with
P saV J cid80
likelihood of the modelcid80n
S LS
Finally the algorithm outputs the probability that any
sequence s was generated as P s  P sV JP V J
This probability can be used to calculate the log-
a1 log P sa and track the
progress of the BW algorithm at each iteration
D Pre-Alignments
For a given sequence there may be many potential can-
didates for the segments V J but not all are equally
plausible especially when sequence reads are long and
not all should be considered Before starting the infer-
ence procedure the sequences are locally aligned against
all genomic templates using the Smith-Waterman algo-
rithm By creating a shortlist of genomic genes that
had an alignment score larger than a tunable threshold
the inference procedure can exclude certain gene choices
a priori This saves considerable computation time by
omitting rearrangement scenarios that would have a neg-
ligible eect due to high numbers of errors
In addition this pre-alignment procedure provides us
with a mapping between the positions along the sequence
read and each genomic gene Thus each of the V and J
states of the HMM may only be present at a single posi-
tion along the sequence drastically limiting the number
of states that we need to consider at each position and
improving the speed of computations
nSnSssi
E Beta and heavy chains
up to a normalisation constant where  denotes
Kroenekers delta
The existence of ghost states requires making a small
adjustment to this scheme Each ghost state introduces
For the beta chain of the TCR or the heavy chain
of the BCR the model is similar to the one in Eq 1
with the addition of a D gene choice its deletions from
is entered from the previous ghost state with probability
P delDl delDrD
F Entropy estimates
cid80
The inferred model can be used to characterise the di-
versity of the distribution of all possible receptors and
not just of the sampled sequences used when inferring
that distribution We quantify the diversity of a stochas-
tic quantity X using the Shannon Entropy HX 
X P X log2 P X measured in bits For instance
Hs gives a measure of sequence diversity Since a uni-
form distribution with 2H outcomes has entropy H the
number 2H can even for non-uniform distributions be
interpreted as an eective diversity number sometimes
called true diversity The entropy of rearrangements can
be calculated explicitly thanks to the factorized form of
the distribution For example for alpha chains
P V HdelV V 
Hr  HV J 
cid88
cid88
P JHdelJJ  Hins
This expression clearly separates the contributions from
V J segment choice deletions and insertions The en-
tropy of sequences Hs cannot be calculated in this way
since receptor sequences can be produced by multiple
rearrangements but can easily be estimated by averag-
ing log P s where P s is calculated by the forward-
backward algorithm as explained above
III RESULTS
Implementation
The method was implemented in C std11 as a
command line tool OpenMP was used for paralleliza-
The main pipeline has two parts the alignment mod-
ule and the inference module The input for the entire
pipeline is a FASTA or plain text le with unique re-
combined and non-productive nucleotide sequences and
FASTA les with the genomic templates for the dierent
V J germline segments as well as D in the case of heavy
or beta chains Genomic les can be obtained from ge-
nomic databases such as IMGT 20 The alignment code
was written to read IMGT FASTA les and extract gene
Between the alignment and inference procedures
alignments below a certain threshold are discarded to im-
prove performance The threshold can be tuned for dier-
ent data sets Sequences that do not align well to at least
one known gene of each type are completely eliminated as
a quality control Setting the thresholds should be done
carefully keeping a large majority of the sequences with
FIG 2 Subdiagram of Markov model for beta and heavy
chain focusing on the D gene Each row corresponds to a
dierent pattern of deletions delDl delDr for the left and
right ends of the D segments State DdelDldelDr
corresponds
to the dth base in the D gene when l bases are deleted from
the left and r from the right Each row is entered from the
ghost state G2 with probability PdelDl r  P delDl delDr
and then proceeds deterministically until G3
both the left and right sides delDl delDr and two in-
dependent insertion events at the VD and DJ junctions
insV D insDJ
Prearrr  P V D JP delV V P insV D
 P delDl delDrDP insDJP delJJ
A similar HMM as for the alpha chain can be built by
adding genomic D states and having two types of inser-
tion states for the VD and DJ junctions and extra ghost
states to separate them Then the procedure described
above can be applied mutatis mutandis
In addition to the V and J gene the D gene has to
be chosen An HMM is built for each triplet of genomic
segments V D J D genes are short and deleted on
both sides For this reason they are much harder to
align Even the position of a candidate genomic D seg-
ment along the sequence is no longer unambiguous as is
the case for V and J segments For this reason we do
not pre-align the D genes to the sequence Instead for
each sequence all D genes with all possible locations are
considered Technically this means that the sequence po-
sitions at which D states may occur are not pre-specied
During the rearrangement process D genes are deleted
from both sides The number of bases truncated from the
left and right ends of the gene are correlated  in the ex-
treme case the sum of both deletions cannot exceed the
length of the gene Since the left and right D deletions
correspond to transitions from non-adjacent states this
correlation cannot be described using a Markov model
We have addressed this issue by enumerating all the pos-
sible deletions from the left and the right as separate
states In practice we dene dierent types of D states
for each choice of deletions as depicted in Fig 2 Each
D deletion prole delDl delDr denes a separate sub-
chain of the Markov chain going along the D gene which
G2D021D022D023G3D112D113D223D114G1G2V1V2VendI1I2IendG3G4I1I2IendJ1J2JendDPdelD02PdelD11PdelD22at least one good alignment but excluding ones which
had only low score alignments To this end an auxiliary
module is included that outputs statistics on the best
alignment score for each sequence Curated alignment
les are saved at the end of the alignments stage and
used as input for the inference Apart from the align-
ments the only parameters needed for inference are the
maximum numbers of insertions and deletions
The output of the main pipeline is the value of the
model parameters the joint distribution of segment us-
age the distributions of deletions at each of the dele-
tion sites conditioned on the gene the distribution of
the number and composition of inserted nucleotides at
the junctions and a global error rate accounting for se-
quencing errors hypermutations or genomic variants
Two more modules are included First given a list of
sequences and an inferred model the software can com-
pute generation probabilities for all sequences Second a
synthetic sequence generation module that can produce
sequences from a given model This module can be used
to study the properties of the distribution or to verify
the inference algorithm using a known model as we will
see below
B Application to alpha chain data
The algorithm was applied to human TCR alpha chain
sequences from 21 The data consist of around 80000
non-productive sequences each 151bp long covering
both the V and J segments Sequences were aligned
to lists of genomic sequences from the IMGT online
database 20 and then given as input to the inference
algorithm The model converged rapidly as can be seen
by the quick saturation of the likelihood Fig 3a
The entropy of the rearrangement process quanties
the diversity of possible scenarios It was calculated us-
ing Eq 10 and found to be 32 bits Fig 3b top line
This entropy can be partitioned into contributions from
each of the rearrangement events  segment choice in-
sertions and deletions bottom line The largest contri-
bution to the entropy comes from the insertions followed
closely by gene choice We also estimated the entropy of
the sequence distribution middle line which is smaller
than the rearrangement entropy because of convergent
rearrangements  multiple rearrangements leading to the
same sequence grey box This estimate was based on
samples of simulated sequences Undersampling bias and
error were corrected for by using samples of dierent sizes
and validating the convergence of the entropy The en-
tropy of the alpha chain sequences is 30bits which cor-
responds to a diversity number of about 109
Inferred insertion and deletion proles for the alpha
rearrangements are shown in Figures 3c and d with the
deletion prole averaged over genes The peak of the
insertion distribution is at 5bp similar to previous results
for the beta chain The joint distribution of gene usage
for V and J represented in Fig 3e shows a wide variety
FIG 3 TCR alpha chain rearrangement distribution inferred
from sequence data taken from 21 a The log-likelihood of
the data given the model saturates as a function of the number
of iterations of the Expectation-Maximisation algorithm b
Shannon entropy of rearrangements top row and sequences
middle row The sequence entropy is lower than the total
recombination entropy because of convergent rearrangements
The rearrangement entropy is the sum of entropies of its ele-
mentary events bottom row c Distribution of the number
of inserted nucleotides red curve For comparison the same
distribution obtained by taking the best alignment of each se-
quence to the genomic templates is represented by the black
dashed line d Distributions of the number of deletions for
both V and J genes These distributions which are gene de-
pendent are here averaged over genes e Joint distribution
for V and J usage P V J Genes are ordered by position
along the genome f The covariance P V J  P V P J
clearly shows strong correlations for genes that are either close
to the separation between the V and J segments or far from
TRAJ3 4 5 6 7 8 9 10111213151617182021222324262728293031323334353637383940414243444546474849505253545657586061TRAV1-11-22345678-19-1101112-18-28-313-112-28-413-2149-212-38-61617181920212223242526-18-727293026-234353638-138-239404110-3123456789iteration 123456789log Likelihood106-584-583-582-5811-11-22102TRAJ3 4 5 6 7 8 9 10111213151617182021222324262728293031323334353637383940414243444546474849505253545657586061TRAV345678-19-1101112-18-28-313-112-28-413-2149-212-38-61617181920212223242526-18-727293026-234353638-138-2394041-3-2-15-1-05005115DelJ31bitsDelV28bitsIns Length39bitsTotal Recombination Entropy32 bitsNucleotide Sequence  30 bitsInsertion Nucleotides11bitsVJ Choice11bitsabcdefnumber of nt insertions0510152025probability000501015inferred modelbest alignmentsnumber of deletions averaged over genes0510152025probability0005010150202503V deletionsJ deletions7
FIG 4 Performance of the algorithm on synthetic data Se-
quences generated using a known model were given as an in-
put to the inference algorithm The results of the inference
are compared to the true model used for generation for a
the distribution of the number of insertions inset usage of in-
serted nucleotides and b V J gene usage The error bars
which correspond to sample noise are smaller than symbol
size for a
FIG 5 TCR beta chain rearrangement distribution inferred
from sequence data previously analysed in 1 a Distribu-
tion of the number of insertions at both VD and DJ junctions
and comparison with the distribution of insertion in the alpha
chain from Fig 3c Inset The nucleotide usage is identical for
VD and DJ insertions when considered on opposite strands
c Distribution of the number of deletions on both the V and
J genes averaged over dierent genes
of gene usage probabilities with clear dependencies on
the ordering of genes according to their location on the
chromosome 22 To better see these dependencies in
Fig 3f we plotted P V J  P V P J as a measure of
the correlation between V and J choices
In 23 it was proposed that rearrangements can oc-
cur in several steps When a V and a J segment are
joined the genomic segments that were between them
are excised but the segments located on the outer anks
remain Then successive rearrangements joining these
outer segments might occur
It was hypothesised that
early joining events involve V and J genes that are close
to each other hence proximal to the boundary between
the V and J cassettes Later joining events on the other
hand should involve more distal genes as the proximal
genes are likely to have been excised This phenomenon
is expected to lead to correlations between pairs of genes
which are either both distal or both proximal which is
consistent with the results of Fig 3f Notice also that
in the intermediate range our model predicts low corre-
lation within a certain window of distances between the
V and J genes
C Test on synthetic data
In order to check the validity of the algorithm we ran it
on sequences that were produced according to a known
model We generated 100000 synthetic sequences ac-
cording to the model learned in the previous section
and relearned a model from these sequences using our
algorithm In Fig 4 we compare the parameters of the
model used for generation to those of the inferred model
Sampling was repeated 5 times to estimate sample noise
which was found to be very small for all paramaters ex-
cept for gene usage error bars in Fig 4b
The insertion bias ie the usage of the dierent nu-
cleotides in inserted segments
is inferred almost per-
fectly as seen in Fig 4a The probabilities for each VJ
choice also show excellent agreement within sampling
errors Fig 4b The distribution of the number of in-
sertions also agrees very well Fig 4c However when
inferring the same model but with a higher error rate
1 we found that the inferred insertion distribution
noticeably overestimated the probability of zero inser-
D Application to beta chain data
The beta and heavy chain algorithm was applied to the
human TCR beta data that was already analysed in 1
using brute-force methods The inferred model param-
eters were all very similar to those reported in 1 con-
rming the validity of our algorithm The distribution
of the number of insertions and deletions are displayed
in Fig 5 Remarkably insertion proles at the two in-
sertion sites are very close to each other as previously
reported but they also closely match the insertion pro-
le of the alpha chain Fig 5a Nucleotide usage in each
of the two inserted regions between V and D and be-
tween D and J is shown in the inset The VD insertion
base usage is similar to the usage of the complementary
bases antisense in the DJ region suggesting that the bi-
ological mechanism is operating on the opposite strands
for both insertions types as previously noted 1 From
the computational point of view because the algorithm
enumerates both the D gene choice and its deletions its
benet is smaller for beta chains than for alpha chains
IV DISCUSSION
The strength of the adaptive immune system lies in its
inherent diversity This dynamic diversity is the result of
several stochastic biological mechanisms including com-
plex enzymatic reactions that alter the DNA structure
and composition The action of some of the enzymes
such as RAG and TdT have been studied extensively
generating model10-30246inferred model10-30246PVJnumber of inserted nucleotides0510152025probability000501015trueinferredACGTprobability00204abnumber of deletions averaged over genes0510152025probability00050101502V deletionsJ deletionsabnumber of insertions0510152025probability00050101502VD insertionsDJ insertionsalpha insertionsACGT00204VD senseDJ antisensesee 24 25 and 26 for reviews In our work we have
studied the way in which the diversity is generated in
a top down approach focusing on statistical properties
as inferred from sequenced receptor genes In principle
this is a computationally dicult problem due to the
very large number of possible rearrangement scenarios
The algorithm described here can be used to study the
properties of generation of receptor chains of B and T
cells in any species from large sequence data sets Our
dynamic programming approach which is a variant of
the Baum-Welch algorithm takes advantage of the lin-
ear structure of rearrangements to avoid a full enumera-
tion of scenarios In a brute-force approach such as the
one presented in 1 and 2 the algorithmic complexity
scales as the product of the numbers of each independent
rearrangement event By contrast the complexity of the
method we presented here is additive with the number of
insertions and deletions
Despite technological advances sequencing techniques
still introduce errors In addition allelic variants and hy-
permutations in B-cells introduce additional discrepan-
cies between known template genes and sequence reads
Our method can be used with models that account for
such events In the presented version of the algorithm
substitution errors are already fully accounted for
sertion and deletion errors could likewise be handled by
adding transitions that skip or repeat bases
We nd many common features of generation for the
alpha and beta chains of the TCR There is a dierence
of diversity due to the greater length and complexity
of the beta compared to the alpha chain The diver-
sity number of the beta chain repertoire estimated to be
approximately 1014 in 1 is therefore much larger than
that of the alpha chain reported here 109 Assuming
that the rearrangements of the alpha and beta chains are
independent the total TCR diversity is about 1023
Inferring statistical properties of the underlying bio-
logical processes can be thought of as a diagnostic tool
for the properties of the immune system and could be
used in a variety of clinical settings The generation pro-
cess and subsequent selection shape the initial diversity
of the immune system and we have found this process
to be remarkably universal across normal healthy hu-
mans expect for slight variations in gene usage 1 2
However infections or irregularities in the immune sys-
tem can be seen as perturbations that will change these
distributions By comparing the normal distributions to
dierent pathological situations information on the re-
action of the immune system can be extracted This in-
formation could in turn be used for diagnosis using fast
computational tools such as the one presented here
With more and more immune repertoire sequence data
being collected ecient algorithms are needed The abil-
ity to quickly infer and analyse large data sets is essential
both for our basic understanding of the adaptive immune
system and also for specic clinical applications
Acknowledgements
We thank members of the Chudakov and Lebedev
groups at the Institute of Bioorganic Chemistry of the
Russian Academy of Sciences and in particular M
Pogorelyy for sharing their TCR alpha data with us
This work was supported by European Research Council
Starting Grant n 306312
1 Murugan A Mora T Walczak AM Callan CG 2012
Statistical inference of the generation probability of T-
cell receptors from sequence repertoires Proceedings of
the National Academy of Sciences of the United States of
America 109161616
2 Elhanati Y et al 2015 Inferring processes underlying
B-cell repertoire diversity Philosophical transactions of
the Royal Society of London Series B Biological sciences
37020140243
3 Paciello G et al 2015 VDJSeq-Solver In Silico VDJ
Recombination Detection Tool Plos One 10e0118192
4 Bonissone S Pevzner P 2015 in Research in Computa-
tional Molecular Biology SE - 7 Lecture Notes in Com-
puter Science ed Przytycka TM Springer International
Publishing Vol 9029 pp 4459
5 Russ DE Ho KY Longo NS 2015 HTJoinSolver Hu-
man immunoglobulin VDJ partitioning using approxi-
mate dynamic programming constrained by conserved
motifs BMC Bioinformatics 16111
6 Nazarov V et al 2015 tcR an R package for T cell
receptor repertoire advanced data analysis BMC Bioin-
formatics 16175
7 Brochet X Lefranc MP Giudicelli V 2008 IMGTV-
QUEST the highly customized and integrated system
for IG and TR standardized V-J and V-D-J sequence
analysis Nucleic acids research 36503508
8 Ye J Ma N Madden TL Ostell JM 2013 IgBLAST an
immunoglobulin variable domain sequence analysis tool
Nucleic acids research 4117
9 Souto-Carneiro MM Longo NS Russ DE Sun Hw Lip-
sky PE 2004 Characterization of the human Ig heavy
chain antigen binding complementarity determining re-
gion 3 using a newly developed software algorithm JOIN-
SOLVER
Journal of immunology Baltimore Md 
1950 17267906802
10 Ohm-Laursen L Nielsen M Larsen SR Barington T
2006 No evidence for the use of DIR D-D fusions chro-
mosome 15 open reading frames or VHreplacement in the
peripheral repertoire was found on application of an im-
proved algorithm JointML to 6329 human immunoglob-
ulin H rearrangements Immunology 119265277
11 Gadala-Maria D Yaari G Uduman M Kleinstein SH
2015 Automated analysis of high-throughput B-cell se-
quencing data reveals a high frequency of novel
munoglobulin V gene segment alleles Proceedings of
the National Academy of Sciences of the United States
of America 112E86270
12 Frost SDW Murrell B Hossain ASMM Silverman GJ
Pond SLK 2015 Assigning and visualizing germline
genes in antibody repertoires Philosophical transactions
of the Royal Society of London Series B Biological sci-
ences 37020140240
13 Gaeta BA et al 2007 iHMMune-align hidden Markov
model-based alignment and identication of germline
genes in rearranged immunoglobulin gene sequences
Bioinformatics 2315801587
14 Munshaw S Kepler TB 2010 SoDA2 a Hidden Markov
Model approach for identication of immunoglobulin re-
arrangements Bioinformatics 26867872
15 Wang X et al 2008 Ab-origin an enhanced tool to
identify the sourcing gene segments in germline for rear-
ranged antibodies BMC bioinformatics 9 Suppl 12S20
16 Volpe JM Cowell LG Kepler TB 2006 SoDA im-
plementation of a 3D alignment algorithm for inference
of antigen receptor recombinations Bioinformatics Ox-
ford England 2243844
17 Ralph DK Matsen Fa 2015 Consistency of VDJ rear-
rangement and substitution parameters enables accurate
B cell receptor sequence annotation
18 Durbin R Eddy SR Krogh A Mitchison G 1998 Bio-
logical sequence analysis probabilistic models of proteins
and nucleic acids Cambridge university press
19 Bishop CM 2006 Pattern recognition and machine
learning springer
20 Giudicelli V Chaume D Lefranc MP
IMGTGENE-DB a comprehensive database for human
and mouse immunoglobulin and T cell receptor genes
Nucleic acids research 33D256D261
21 Zvyagin IV et al 2014 Distinctive properties of identi-
cal twins TCR repertoires revealed by high-throughput
sequencing Proceedings of the National Academy of Sci-
ences of the United States of America 11159805
22 Lefranc MP Lefranc G 2001 The T Cell Receptor Facts-
Book Factsbook Elsevier Science
23 Warmash A Dinner AR 2006 A Model for TCR Gene
Segment Use The Journal of Immunology 1773857
24 Schatz DG Swanson PC 2011 VDJ recombination
mechanisms of initiation Annual review of genetics
45167202
25 Jung D Alt FW 2004 Unraveling VDJ recombina-
tion insights into gene regulation Cell 116299311
26 Schatz DG Ji Y 2011 Recombination centres and the
orchestration of VDJ recombination Nature reviews
Immunology 1125163
