Quantifying selection in immune receptor repertoires
Yuval Elhanati1 Anand Murugan2 Curtis G Callan Jr3 Thierry Mora4 and Aleksandra M Walczak1
1Laboratoire de physique theorique UMR8549 CNRS and Ecole normale superieure 24 rue Lhomond 75005 Paris France
2Department of Applied Physics Stanford University California 94305 USA
4Laboratoire de physique statistique UMR8550 CNRS and Ecole normale superieure 24 rue Lhomond 75005 Paris France
3Joseph Henry Laboratories Princeton University Princeton New Jersey 08544 USA
Dated April 22 2014
The ecient recognition of pathogens by the adaptive immune system relies on the diversity of
receptors displayed at the surface of immune cells T-cell receptor diversity results from an initial
random DNA editing process called VDJ recombination followed by functional selection of cells
according to the interaction of their surface receptors with self and foreign antigenic peptides To
quantify the eect of selection on the highly variable elements of the receptor we apply a probabilistic
maximum likelihood approach to the analysis of high-throughput sequence data from the -chain
of human T-cell receptors We quantify selection factors for V and J gene choice and for the length
and amino-acid composition of the variable region Our approach is necessary to disentangle the
eects of selection from biases inherent in the recombination process Inferred selection factors dier
little between donors or between naive and memory repertoires The number of sequences shared
between donors is well-predicted by the model indicating a purely stochastic origin of such public
sequences We nd a signicant correlation between biases induced by VDJ recombination and our
inferred selection factors together with a reduction of diversity during selection Both eects suggest
that natural selection acting on the recombination process has anticipated the selection pressures
experienced during somatic evolution
Signicance statement
The immune system defends against pathogens via
a diverse population of T-cells that display dierent
antigen recognition surface receptor proteins Recep-
tor diversity is produced by an initial random gene
recombination process followed by selection for a de-
sirable range of peptide binding Although recombina-
tion is well-understood selection has not been quan-
titatively characterized By combining high through-
put sequencing data with modeling we quantify the
selection pressure that shapes functional repertoires
Selection is found to vary little between individuals or
between the naive and memory repertoires
It rein-
forces the biases of the recombination process mean-
ing that sequences more likely to be produced are also
more likely to pass selection The model accounts for
public sequences shared between individuals as re-
sulting from pure chance
The T-cell response of the adaptive immune system be-
gins when receptor proteins on the surface of these cells
recognize a pathogen peptide presented by an antigen
presenting cell The immune cell repertoire of a given
individual is comprised of many clones each with a dis-
tinct surface receptor This diversity which is central to
the ability of the immune system to defeat pathogens is
initially created by a stochastic process of germline DNA
editing called VDJ recombination that gives each new
immune cell a unique surface receptor gene This initial
repertoire is subsequently modied by selective forces
including thymic selection against excessive or insu-
cient recognition of self proteins that are also stochas-
tic in nature Due to this stochasticity and the large
T-cell diversity these repertoires are best described by
probability distributions In this paper we apply a prob-
abilistic approach to sequence data to obtain quantita-
tive measures of the selection pressures that shape T-cell
receptor repertoires
New receptor genes are formed by choosing at random
from a set of genomic templates for several sub-regions
V D and J of the complete gene Insertion and dele-
tion of nucleotides in the junctional regions between the
V and D and D and J genes greatly enhances diversity
beyond pure VDJ combinatorics 1 The variable region
of the gene lies between the last amino acids of the V
segment and the beginning of the J segment it codes
for the Complementarity Determining Region 3 CDR3
loop of the receptor protein a region known to be func-
tionally important in recognition 2 Previous studies
have shown that immune cell receptors are not uniform
in terms of VDJ gene segment usage 36 or probabil-
ity of generation 1 and that certain receptors are more
likely than others to be shared by dierent individuals
4 7
In other words the statistical properties of the
immune repertoire are rather complex and their accu-
rate determination requires sophisticated methods
Over the past few years advances in sequencing tech-
nology have made it possible to sample the T-cell re-
ceptor diversity of individual subjects in great depth 8
and this has in turn led to the development of sequence
statistics-based approaches to the study of immune cell
diversity 9 10
In particular we recently quantita-
tively characterized the primary pre-selection diversity
of the human T-cell repertoire by learning the probabilis-
tic rules of VDJ recombination from out-of-frame DNA
sequences that cannot be subject to functional selection
and whose statistics can reect only the recombination
process 1 After generation T-cells undergo a somatic
selection process in the thymus 11 and later in the pe-
riphery 12 Cells that pass thymic selection enter the
peripheral repertoire as naive T-cells and the subset of
naive cells that eventually engage in an immune response
will survive as a long-lived memory pool Even though
we now understand the statistical properties of the ini-
tial repertoire of immune receptors 1 and despite some
theoretical studies of thymic selection at the molecular
level 13 14 a quantitative understanding of how selec-
tion modies those statistics to produce the naive and
memory repertoires is lacking
In this paper we build on our understanding of the
primitive pre-selection distribution of T-cell receptors to
derive a statistical method for identifying and quantify-
ing selection pressures in the adaptive immune system
We apply this method to naive and memory DNA se-
quences of human T-cell  chains obtained from periph-
eral blood samples of nine healthy individuals Fig 1
Our goal is to characterize the likelihood that any given
sequence once generated will survive selection Our
analysis reveals strong and reproducible signatures of se-
lection on specic amino acids in the CDR3 sequence and
on the usage of V and J genes Most strikingly we nd
signicant correlation between the primitive generation
probability of a sequence and the probability it will pass
selection This suggests that natural selection which acts
on very long time scales to shape the generation mecha-
nism itself may have tuned it to anticipate somatic se-
lection which acts on single cells throughout the lifetime
of an individual The quantitative features of selection
inferred from our model vary very little between donors
indicating that these features are universal In addition
our measures of selection pressure on the memory and
naive repertoires are statistically indistinguishable con-
sistent with the hypothesis that the memory pool is a
random subsample of the naive pool
I METHODS
We analyzed human CD4 T-cell -chain DNA se-
quence reads 60 or 101 nucleotides long centered around
the CDR3 region T-cells were obtained from nine in-
dividuals and sorted into naive CD45RO- and mem-
ory CD45RO subsets yielding datasets of 200000
unique naive and 120000 unique memory sequences per
individual on average The datasets are the same as
those used in 1 and were obtained by previously de-
scribed methods 15 16
In 1 we used the nonproductive sequences those
where either the J sequences are out of frame or the
CDR3 sequences have a stop codon to characterize the
receptor generation process The result of that analysis
was an evaluation of the probability Pprecid126 that a VDJ
recombination event will produce a -chain gene consis-
tent with the specic DNA sequence read cid126 In this study
we focus instead on the in-frame productive sequences
from both the naive and the memory repertoires with
the goal of quantifying how the post-selection probabil-
ity distribution on sequences is modied from the origi-
nal distribution Pprecid126 In what follows we distinguish
between the read cid126 and the CDR3 region cid126  the latter
dened to run from a conserved cysteine near the end of
the V segment to the last amino acid of the read leaving
two amino acids to the conserved Phe The CDR3 amino
acid sequence can be uniquely read o from each in-frame
sequence read by contrast the specic V- and J-genes
responsible for the read may not be uniquely identiable
because of the relatively short read length An unam-
biguous selection eect can be seen by comparing the
length distribution of CDR3 regions between the pre-
selection ensemble and the naive or memory datasets
Fig 2A sequences that are longer or shorter than the
mean are suppressed resulting in a more peaked distri-
bution
For each receptor sequence we dene a selection fac-
tor Qcid126 that quanties whether selection thymic se-
lection or later selection in the periphery has enriched
or impoverished the frequency of cid126 compared to the
pre-selection ensemble Since the generation probabil-
ity of sequences varies over many orders of magnitude
such a comparison is the only way to dene selection
strength Denoting by Ppostcid126 the distribution of se-
quences in the selected naive or memory pools we will
set Ppostcid126  Qcid126Pprecid126 Due to the large number of
possible sequences we cannot sample the post-selection
probability Ppost for each sequence directly from the
data we need a reduced complexity model to estimate
it We propose a simple model summarized in Fig 1A
that we we will show captures the main features of selec-
Lcid89
Qcid126  V J 
Ppostcid126  V J
Pprecid126  V J
qL qV J
qiLai
cid80
where V and J denote the choice of V and J segments
in the sequence cid126 L is the amino-acid length of the
CDR3 specied by the read 1     3L is CDR3 nu-
cleotide sequence and a1     aL its amino-acid se-
quence The factors qL qiLa and qV J denote respec-
tively selective pressures on the CDR3 length its com-
position and the associated VJ identities Note that
the D segment is entirely included in this junctional re-
gion so selection acting on it is encoded in the qiL
factors Z enforces the model normalization condition
cid126 VJ Qcid126  V JPprecid126  V J  1
It is important to understand why we do not write
Q directly as a function of the read cid126 While cid126  V J
determines cid126 and cid126 determines cid126  V and J cannot always
be inferred deterministically from the read cid126 The VJ
assignment of any given read will have to be treated as
probabilistically dened hidden variables
In addition
because of correlations in Ppre the q factors cannot be
identied with marginal enrichment factors so that for
dicted even though they are not model inputs
also noteworthy that they are nonzero even though the
selection model does not take into account the possibil-
ity of interactions in the selection factors qiL This is
because the pre-selection distribution does not factorize
over amino acids in the CDR3 region and has correla-
tions of its own as shown by the green points of Fig 2B
note that these pre-selection correlations do not agree
well with those observed in the post-selection data
Another assumption of our model is that selection acts
at the level of the amino acid sequence regardless of the
underlying codons To test this we learned more general
models where a represented one of the possible 61 codons
instead of one of the 20 amino acids We found that
codons coding for the same residue had similar selection
factors see Fig 8 except near the edges of the CDR3
where amino acids may actually come from genomic V
and J segments and reect their codon biases
To compare the dierent donors we learned a distinct
model for each donor as well as a universal model for
all sequences of a given type from all donors taken to-
gether see the appendices for details We also learned
models from random subsets of the sequence dataset to
assess the eects of low-number statistical noise
II RESULTS
A Characteristics of selection and repertoire
variability
The length single-residue and VJ selection factors
learned from the naive datasets of all donors taken to-
gether are presented in Fig 2ACD The qV J distribu-
tion shows that the dierent V and J genes are subject to
a wide range of selection factors note that these factors
act in addition to the quite varied gene segment usage
probabilities in Pprecid126 We looked for correlations be-
tween the selection factors qiLa on amino acids and
a variety of amino-acid biochemical properties 17 hy-
drophobicity charge pH polarity volume and propensi-
ties to be found in  or  structures in turns at the sur-
face of a binding interface on the rim or in the core 18
see the appendices for details and references We found
no signicant correlations save for a negative correlation
with amino acid volume and  helix association as well
as a positive correlation with the propensities to be in
turns or in the core of an interacting complex Fig 13
To estimate dierences between datasets we calcu-
lated the correlation coecients between the logs of the
qV J and qiLa selection factors see Fig 10 Compar-
ing naive vs naive memory vs memory or naive vs
memory between donors see Fig 3A-C for an example
for qiL and Fig 9 for qV J  gave correlation coecients
of  09 in log qiL while the naive vs memory reper-
toires of the same donor gave 095 To get a lower bound
on small-number statistical noise we also compared the
factors inferred from articial datasets obtained by ran-
FIG 1 A T-cell receptor  chain sequences are formed dur-
ing VDJ recombination Sequences from this probability dis-
tribution described by Ppre are then selected with a factor
Q dened for each sequence resulting in the observed Ppost
distribution of receptor sequences Selection is assumed to
act independently on the V and J genes the length of the
CDR3 region and each of the amino acids ai therein B
A schematic of the tting procedure the parameters are set
so that Ppost ts the marginal frequencies of amino acids at
each position the distribution of CDR3 lengths and VJ gene
choices Since the latter is not known unambiguously from
the observed sequences it is estimated probabilistically using
the model itself in an iterative procedure
example PiLdataaiPiLpreai cannot be set equal to
qiLai For all these reasons we must use a maximum
likelihood procedure to learn the qL qiL and qVJ factors
of Eq 1 We use an expectation maximization algorithm
EM that iteratively modies the qcid48s until the observed
marginal frequencies for CDR3 length amino acid usage
as a function of CDR3 position and VJ usage in the
data match those implied by the model distribution Eq 1
the pre-selection distribution Ppre being taken as a xed
known input The procedure is schematically depicted
in Fig 1B see the appendices for full details
One important assumption of the model is that se-
lection factors act independently of each other on the
sequence Consequently while the model is t only to
single point marginal frequencies and not to pairwise
frequencies To check the validity of this assumption
we plot the correlation functions of amino acid pairs in
the model post-selection repertoire vs the observed naive
ones Fig 2B These pairwise correlations are well pre-
CDR3VJQqVJq1LqLq2La1a2 L APpreTCRVDJrecombinationQselection  qLLaLPpostB    V2J1-2V5-7J1-3V10-2J2-2V3-1J1-1V4-1J1-4V19J2-1sequence 1sequence 1  sequence NPpostV2 J1-2  seq1PpostV5-7 J1-3  seq1PpostV10-2 J2-2  seq1PpostV3-1 J1-2  seq2PpostV4-1 J1-4  seq2PpostV19 J1-4  seq2averagePdataLPiLdataaiqVJqiLqLupdatesetto match modelmarginalsto datamarginalsPdataVJ4
FIG 3 A-C Variability between repertoires The scatter
between qiL selection factors between two sample individuals
A and B for naive A and memory repertoires B compared
to that of memory and naive repertoires for the same individ-
ual C shows great similarity between them See also Fig 11
D The entropy of the pre-selection repertoire top is reduced
in the post-selection repertoire bottom E-F Distribution
of V J E and DJ F insertions in the pre-selection and
naive repertoires shows elimination of long insertions Error
bars show standard deviations over 9 donors The insertion
distributions for the memory repertoire are the same as for
the naive repertoire see scatter plots in insets
FIG 2
A CDR3 length distributions pre- and post-
selection and the length selection factor qL green Selection
makes the length-distribution of CDR3 regions in the pre-
selection repertoire more peaked for the naive and memory
repertoires overlapping Error bars show standard variation
over 9 individuals B Comparison between data and model
of the connected pairwise correlation functions which were
not tted by our model The excellent agreement validates
the inference procedure As a control the prediction from the
pre-selection model in gray does not agree with the data as
well C Values of the inferred amino-acid selection factors
for each amino acid ordered by length of the CDR3 region
ordinate and position in the region abscissa D Values of
the V J gene selection factors
domly shuing sequences between donors see the appen-
dices yielding an average correlation coecient of 098
Repeating the analysis for log qV J  we found correlation
coecients of  08 between datasets of dierent donors
084 for the naive and memory dataset of the same donor
all of which must be compared to 094 obtained between
shued datasets Thus the observed variability between
donors of qiL and qV J are small and consistent with
their expected statistical variability
cid80
entropy
Shannon
cid126 Ppostcid126 log2 Ppostcid126
to quantify the diver-
sity of the naive and memory distributions Entropy is
a diversity measure that accounts for non-uniformity
of the distribution and is additive in independent
components Since S  log2  when there are  equally
likely outcomes the diversity index 2S can be viewed as
an eective number of states The entropy of the naive
repertoire according to the model is 38 bits correspond-
ing to a diversity of  30  1011 down from 435 bits
in the primitive pre-selection repertoire Fig 3D This
is a reduction of  6 bits or 50-fold in diversity The
majority of the reduction comes from insertions and
deletions which accounted for most of the diversity
in the pre-selection repertoire The entropies of the
memory and naive repertoires are the same indicating
that selection in the periphery does not further reduce
diversity
510152000050101502lengthofCDR3 aa  005115preselnaivememoryqLAlaArgAsnAspCysGlnGluGlyHisIleLeuLysMetPheProSerThrTrpTyrVal  0051152position ilength L8151158qiLaaABCqVJD  V2V31V41V42V43V51V54V55V56V58V61V62V63V64V65V66V68V69V72V73V74V76V77V78V79V9V101V102V103V111V112V113V123V124V125V13V14V15V16V18V19V201V241V251V27V28V291V30J11J12J13J14J15J16J21J22J23J24J25J26J270051152001iapjaPredicted 0101005000501Observed pijabp preselectionpostselectionpreselectionpostselectionqLPLNucleotide Sequence  435 bitsConvergentRecombVJSelected repertoire  38 bitsDiversitylossVJ0510152000050101502Number of VJ insertionsProbability  preselectionnaive0510152000050101502Number of DJ insertionsProbability  preselectionnaive01230123qi ind A naiveqi ind B naive01230123qi ind A memoryqi ind B memory01230123qi ind A naiveqi ind A memoryDEFABC0010200050101502naivememory0010200050101502naivememory5
By construction the distribution of Q in the post-
selection model satises exactly PpostQ  QPpreQ
In Fig 4A-B we plot the ratio PdataQPpreQ as a
function of Q both for the naive and memory models
learned from all donors We observe that for Q  5 ie
for  90 of sequences this ratio is exactly equal to Q 
a validation of our model prediction at the sequence-wide
level For larger values of Q however this ratio saturates
to around Qmax  7
This plateau may be viewed as a limiting value above
which selection is insensitive to Q A similar plateau
was observed in the tness of transcription factor binding
sites below a certain binding energy 20 In the case con-
sidered here the plateau can be rationalized if we assume
that Q is proportional to the probability for a sequence
lection is given bycid80
to be selected Pselcid126  Qcid126 Since Psel cannot exceed
one Q cannot exceed 1 The average probability of se-
cid126 Pprecid126Pselcid126   The observed
plateau gives a lower bound to the true maximum of Q
1  Qmax and thus the average fraction of cells to
pass selection satises   15 This can be compared
to estimates 2 for passing positive and negative thymic
selection 10 30 for positive selection only and  5
for both This analysis only includes the  chain and
including the  chain could further reduce our estimate
The saturation also seems to indicate that our model
may be too simple to describe the very t high Q se-
quences Because of its fairly simple factorized structure
our model can only account for the coarse features of
selection and may not capture very individual-specic
traits such as avoidance of the self corresponding to
Q cid28 1 in localized regions of the sequence space or
response to pathogens Q cid29 1 for particular sequences
This individual-dependent ruggedness of the tness land-
scape Q schematized in Fig 4C is probably ignored by
our description and may be hard to model in general
To check that the saturation does not aect our infer-
ence procedure we relearned our model parameters from
simulated data where sequences were generated from
Ppre and then selected with probability minQQmax 1
see the appendices for details and we found that the
model was correctly recovered Fig 12
FIG 4 Probability of passing selection A-B Ratio of the
distributions of sequence-wide selection factors Q between the
observed sequences and the pre-selection ensemble red line
plotted as a function of Q for naive A and memory B
repertoires The model prediction PpostQPpreQ  Q is
shown in black and the pre-selection and observed distribu-
tions of Q are shown in the insets The selection ratio saturate
around  7 which may be interpreted as the maximum prob-
ability of being selected Naive and memory repertoires show
similar behaviors C A cartoon of the eective selection land-
scape captured by our model red line Our method does not
capture localized selection pressures such as avoiding self
specic to each individual but captures general global prop-
erties
Knowing the post-selection distribution of sequences
we can ask how dierent features of the recombination
scenario fare in the face of selection This does not imply
that selection acts on the scenarios themselves it acts
on the nal product but it is an a posteriori assessment
of the tness of particular rearrangements For example
the distributions of insertions at VD and DJ junctions in
the post-selection ensemble have shorter tails Fig 3E-
F while the distribution of deletions at the junctions
seems little aected by selection Fig 11 although large
numbers of deletions are selected against
B Selection factor as a measure of tness
The selection factor Q is a proxy for the probability
of a particular sequence to be selected or amplied and
sequences with large Q values should thus be enriched in
the observed dataset To test this we consider the dis-
tributions of Q both in the pre-selection model PpreQ
and in the dataset from which Q was learned PdataQ
insets of Fig 4 see the appendices for details on how
the distributions are calculated when V and J are hidden
variables This approach is very similar to the one used
by Mustonen et al
19 20 to characterize the tness
landscape of transcription factor binding sites
C Natural selection anticipates somatic selection
Comparing the pre- and post-selection length distri-
butions in Fig 2A shows that the CDR3 lengths that
were the most probable to be produced by recombina-
tion are also more likely to be selected Formally Spear-
mans rank correlation coecient between PpreL and
qL is 076 showing good correlation between the prob-
ability of a CDR3 length and the corresponding selec-
tion factor We asked whether this correlation was also
present in the other sequence features The histogram
of Spearmans correlation between the selection factors
qiLa and the pre-selection amino-acid usage PiLprea
for dierent lengths and positions i L Fig 5A shows
individual Aindividual Binferred model05101551015Q Ratio PdataQPpreQNaive sequences510150QMemory sequencesCABPpostQPpreQQPpostQPpreQQsequenceQ02468123QPQ  preselectiondata02468123QPQ  preselectiondata6
FIG 6
Shared sequences between individuals A The
mean number of shared sequences between any pair of indi-
viduals compared to the number expected by chance model
prediction for one common model for all individuals red
crosses and private models learned independently for each
individual blue crosses Error bars are standard deviations
from distributions over pairs The distribution of shared se-
quences between triplets B and quadruplets C of indi-
viduals for the data black histogram from common red
line and private models blue line D The shared sequences
are most likely to be generated and selected comparison of
the Ppost post-selection distribution for sequences from the
pre-selection dotted line and post-selection repertoires ac-
cording to the model in gray and to the data in black as
well as the sequences shared by at least two donors model
prediction in magenta data in red
quences make up a public repertoire common to many
individuals formed through convergent evolution or a
common source However it is also possible that these
common sequences are just statistically more frequent
and are likely to be randomly recombined in two individ-
uals independently as previously discussed by Venturi et
al 6 7 21 In other words public sequences could just
be chance events Here we revisit this question by asking
whether the number of observed shared sequences be-
tween individuals is consistent with random choice from
our inferred sequence distribution Ppost
We estimated the expected number of shared sequences
between groups of donors in two ways i by assuming
that each donor  had its own private model learned
from his own sequences or ii by assuming that sequences
are drawn from a universal model learned from all
sequences together While the latter ignores small yet
perhaps signicant dierences between the donors the
former may exaggerate them where statistics are poor
For details on how these estimates are obtained from the
models we refer the reader to the appendices In Fig 6A
FIG 5 Correlations between the pre- and post-selection
repertoires A A histogram of Spearmans correlation coe-
cient values between the qiLa selection factors in the CDR3
region and their generation probabilities PiLprea for all i L
shows an abundance of positive correlations B Heatmap of
the joint distribution of the pre-selection probability distri-
bution Ppre and selection factors Q for each sequence shows
the two quantities are correlated C Sequences in the ob-
served selected repertoire green line had a higher probabil-
ity to have been generated by recombination than unselected
sequences blue line Agreement between the post-selection
model red line and data distribution green line is a vali-
dation of the model
a clear majority of positive correlations Likewise the
selection factors qV J are positively correlated with the
pre-selection VJ usage PV Jpre Spearmans rank correla-
tion 03 p  2  1020
The correlations observed for each particular feature
of the sequence CDR3 length amino acid composition
and VJ usage combine to create a global correlation
between the probability Pprecid126 that a sequence cid126 was
generated by recombination and its propensity Qcid126 to
be selected Spearmans rank correlation 04 p  0
see Fig 5B Consistent with this observation the post-
selection repertoire is enriched in sequences that have a
high probability Pprecid126 to be produced by recombina-
tion Fig 5C This enrichment is well predicted by the
model providing another validation of its predictions at
the sequence-wide level
Taken together these results suggest that the mech-
anism of VDJ recombination including insertions and
deletions has evolved to preferentially produce sequences
that are more likely to be selected by thymic or periph-
eral selection
D Shared sequences between individuals
The observation of unique sequences that are shared
between dierent donors has suggested that these se-
151050051log10 Q 000501005105101520Spearmans correlationcountCCqiLaPiLprea201510500050101502log10 PpreDensity  ABCpreselectionpostselectiondata01002003004005000100200300400500600Shared sequences between pairsModel prediction  Common modelPrivate models0102000102Shared sequencesbetween tripletsFrequency  ObservedCommon ModelPrivate Models024680051Shared sequencesbetween quadruplets  ObservedCommon ModelPrivate Models2015105020406log10 Ppost  densitypre-selectionpost-selectionpredictedpost-selectiondatasharedpredictedshared dataABCDwe plot for each pair of donors the expected number of
shared nucleotide sequences in their naive repertoires un-
der assumptions i and ii versus the observed number
The number is well predicted under both assumptions
the universal model assumption giving a slight overes-
timate and the private model giving a slight underes-
timate We repeat the analysis for sequences that are
observed to be common to at least three or at least four
donors Fig 6B-C The universal model predicts their
number better than the private models although it still
slightly overestimates it
These results suggest that shared sequences are indeed
the result of pure chance If that is so shared sequences
should have a higher occurrence probability than average
specically the model predicts that the sequences that
are shared between at least two donors are distributed
according to Ppostcid1262 see the appendices We test this
by plotting the distribution of Ppost for regular sequences
as well as for pairwise-shared sequences according to the
model and in the naive datasets Fig 6D and nd ex-
cellent agreement In general sequences that are shared
between at least n individuals by chance should be dis-
tributed according to Ppostcid126n For triplets and quadru-
plets this model prediction is not as well veried see
Fig 14 This discrepancy may be explained by the fact
that such sequences are outliers with very high occur-
rence probabilities and may not be well captured by the
model which was learned on typical sequences
We repeated these analyses for sequences shared be-
tween the memory repertoires of dierent individuals
with very similar conclusions except for donors 2 and
3 and donors 2 and 7 who shared many more sequences
than expected by chance see Fig 15 We conclude that
the vast majority of shared sequences occur by chance
and are well predicted by our model of random recombi-
nation and selection
III DISCUSSION
We have introduced and calculated a selection factor
Qcid126 that serves as a measure of selection acting on a
given receptor sequence cid126 in the somatic evolution of the
immune repertoire Our approach accounts for the fact
that the pre-selection probabilities of sequences vary over
orders of magnitude
Using this measure we show that the observed reper-
toires have undergone signicant selection starting from
the initial repertoire produced by VDJ recombination
We nd little dierence between the naive and memory
repertoires in agreement with recent ndings showing
no correlation between receptor and T-cell fate 22 as
well as between the repertoires of dierent donors This
is perhaps surprising because the donors have distinct
HLA types which determine the interaction between
T-cell receptors and peptide-MHC complexes and we
could expect their positive and negative selective pres-
sures to be markedly dierent Besides memory se-
quences have undergone an additional layer of selection
compared to the naive ones recognizing a pathogen
and we could also expect to see dierent signatures of
selection there A possible interpretation is that our
model only captures coarse and universal features of se-
lection related to the general tness of receptors and
not the ne-grained
individual-specic selective pres-
sures such as avoidance of the self as illustrated schemat-
ically in Fig 4C In other words our selection factors may
smooth out the complex landscapes of specic reper-
toires and fail to capture their rough local properties
such as would be expected from specic epitopes that
would correspond to very tall peaks or deep valleys in
the landscape of selection factors To really probe these
specic deep valleys we need to develop methods based
on accurate sequence counts Another interesting future
direction would be to see whether at this global level
the signatures of selection are similar between relatively
isolated populations Lastly comparing data from dier-
ent species mice sh in particular where inbred indi-
viduals with the same HLA type can be compared would
be an interesting avenue for addressing these issues
Our results suggest that natural selection has rened
the generation process over evolutionary time scales to
produce a pre-selection repertoire that anticipates the
actions of selection Sequences that are likely to be elim-
inated and fail selection are not very likely to be produced
in the rst place Because of this rich become richer ef-
fect the diversity of the repertoire is signicantly reduced
by selection by a 50-fold factor in terms of diversity in-
dex This does not mean that only 2 of the sequences
pass selection
In fact our results are consistent with
as much as 15 of sequences passing selection This ap-
parent paradox is resolved by noting that selection by
keeping clones that were likely to be generated get rids
of very rare clones that contributed to the large initial
diversity
Although we did observe sequences that were present
in the repertoires of dierent donors we showed using our
model that their number was broadly compatible with
that expected by pure chance This suggests that the
public part of the repertoire is made of sequences that
are just more likely to be randomly produced and se-
lected
To summarize our work clearly shows that thymic se-
lection and later peripheral selection modify the form of
the generated repertoire Our work is a starting point for
a description of a mechanism of the two processes
Acknowledgements The work of YE TM and AW
was supported in part by grant ERCStG n 306312 The
work of CC was supported in part by NSF grants PHY-
0957573 and PHY-1305525 and by WM Keck Founda-
tion Award dated 121509
Acknowledgements The work of YE TM and AW
was supported in part by grant ERCStG n 306312 The
work of CC was supported in part by NSF grants PHY-
0957573 and PHY-1305525 and by WM Keck Founda-
tion Award dated 121509
Appendix A Data
combination scenarios S 1
The DNA nucleotide data used in our analysis con-
sists of human CD4 naive CD45RO- or memory
CD45RO  chain sequences from 9 healthy indi-
viduals sequenced and made available to us by H
Robins and already used in 1 Reads are 60 base
pair long for 6 donors and 101 base pair long for 3
donors individuals 2 3 and 7 and contain the CDR3
region and neighboring V and J gene nucleotides All
end at the same position in the J gene with four nu-
cleotides between this position and the rst nucleotide
of the conserved phenylalanine The data were divided
into out-of-frame reads non-coding used to learn the
pre-selection model as described in 1 and in-frame
coding reads used in the analysis presented in this
paper The sequence data we used are available at
httpprincetoneduccallanTCRPaperdata
In our study we limit ourselves to unique sequences
The experimental procedure and initial assessment of the
quality of the reads were done in the Robins lab following
the procedures described in 15 23 Each sequence was
read multiple times allowing for the correction of most
sequencing errors The numbers of unique sequences used
in each dataset is shown in Table SI
PpreS P V P D JP insVDP insDJ
P delVV P dellD delrDDP delJJ
P s1P s2s1 P sinsVDsinsVD1
P t1P t2t1 P tinsDJtinsDJ1
insertions
two junctions
together with the
delVdellD
where a scenario is given by the VDJ choice
insDJ and the num-
number of
delrDdelJ at each
ber of deletions
identi-
ties s1     sinsVDt1     tinsDJ of the inserted nu-
cleotides It is worth noting that the insertions are as-
sumed to be independent of the identities of the genes
between which insertions are made By contrast the
deletion probabilities are allowed to depend on the iden-
tity of the gene being deleted These validity of these
assumptions is veried a posteriori
Appendix C Model tting
1 Maximum likelihood formulation
Naive Memory
cleotide sequence is
The model probability to observe a given coding nu-
Donor 1 311917 177744
Donor 2 242254 135567
Donor 3 195007 119906
Donor 4 130958 142017
Donor 5 147848 32468
Donor 6 187245 104119
Donor 7 251335 136419
Donor 8 42326 120527
Donor 9 254349 89830
TABLE I Number of unique coding sequences in each
datasets
The alignment to all possible V and J genes was done
using the curated datasets in the IMGT database 24
There are 48 V genes 2 D genes and 13 J genes plus a
number of pseudo V genes that cannot lead to a function-
ing receptor due to stop codons We discarded sequences
that were associated to a pseudo-gene as our model only
accounts for coding genes The germline sequences of the
genes used in our analysis are the same as were used in
1 to analyze the generative VDJ recombination pro-
cess The complete list of gene sequences can be found at
httpprincetoneduccallanTCRPapergenes
Appendix B Pre-selection model
The pre-selection or generative model assumes the
following structure for the probability distribution of re-
Ppostcid126  V J  Qcid126  V JPprecid126  V J
where cid126  1     3L is the nucleotide sequence of the
CDR3 dened as running from the conserved cysteine
in the V segment up to the last amino acid in the read
leaving two amino acids between the last read amino acid
and the conserved phenylalanine in the J segment L is
the length of the CDR3 and V and J index the choice
of the germline V and J segments which completely de-
termine the sequence outside the CDR3 region The D
segment is entirely absorved into cid126  and is not explicitly
tracked in assessing selection The selection factor Q is
assumed to take the following factorized form
Qcid126  V J 
qL qVJ
qiLai
Lcid89
cid88
where cid126a  a1     aL is the amino-acid sequence of the
CDR3 and Z is a normalization constant that enforces
Ppostcid126  V J  1
cid126 VJ
The probability Pprecid126  V J of generating a specic
sequence in a VDJ recombination event can be ob-
tained from the noncoding sequence reads by the meth-
ods explained in 1 Specically the pre-selection model
gives the probability PpreS of a recombination scenario
S  V D J insVD insDJ delV    as given by Eq B1
A scenario S completely determines the sequence cid126  but
cid88
VJcid126 cid126
Ncid89
nucleotides depending on the donor
Ppostcid126 
Ppostcid126  V J
where we note again that cid126  V J fully species cid126 while
cid126 fully species cid126  but not V and J Given a dataset of
N sequences cid1261     cid126N see Fig 7 for notations the
likelihood reads
Ppostcid126a
Our goal is maximize L with respect to the parameters
qL qVJ  and qiL globally refered to as Q
2 Expectation maximization
Calculating Ppostcid126
is computationally intensive
Given the form of the model it seems more natural to
work with Ppostcid126  V J but this likelihood involves the
hidden variables V and J To circumvent this problem
we use the expectation maximization algorithm 25 26
This algorithm uses an iterative two-step process with
two sets of model parameters Q and Qcid48 The log-
likelihood of the data is calculated using the set of param-
eters Qcid48 in the Expectation step this log-likelihood is
averaged over the hidden variables with their posterior
probabilities which are calculated using the second set
of parameters Q In the Maximization step this av-
erage log-likelihood is maximized over the rst set Qcid48
while keeping the second set Q xed Then Q is updated
to the optimal value of Qcid48 and the two steps are repeated
iteratively until convergence
In practice starting with a test set of parameters Q
we calculate for each sequence of the data the posterior
probability of a V J pair
PpostVa Jacid126a 
Qcid126 a Va JaPprecid126 a Va Ja
VJ Qcid126 a V JPprecid126 a V J
The log-likelihood expressed in terms of the hidden vari-
ables V and J is maximized after averaging over V and
J using that posterior Specically we will maximize
cid80
Ncid88
cid88
cid48
Ncid88
V aJ a
cid48
cid104log Ppostcid126 a Va Ja Q
cid105Q
cid48
PpostVa Jacid126a Q log Ppostcid126 a Va Ja Q
Here we have added the Q dependencies explicitly be-
cause there are two dierent parameter sets Q and
Qcid48 The maximization is performed over Qcid48 which
parametrizes the log-likelihood itself while keeping Q
FIG 7 Summary of the notations used in this paper for the
sequences The CDR3 region is dened from the conserved
cysteine around the end of the V segment to the last amino-
acid in the read leaving two amino acids to the conserved
phenylalanine in the J segment The nucleotides in the read
are dened as i the nucleotides in the CDR3 region as i
and the amino acids in the CDR3 region as ai The data
sequences therefore can be dened in terms of cid126 or their V 
J genes and cid126  The generated sequences with known V and
J genes are dened in terms of cid126 for the whole sequence or cid126
for only the CDR3
the converse is not true The pre-selection probability
for a coding sequence is thus given by
Pprecid126  V J 
pcoding
Scid126 VJ
PpreS
cid88
where we sum over scenarios resulting in a particular
CDR3 sequence cid126 and a particular V J pair The nor-
malization factor pcoding  026 corrects for the fact that
a randomly generated sequence is not always productive
ie in-frame and with no stop codon From this point
on we regard the initial generation probability of any
specic read as known When we make statements about
the pre-selection distribution of CDR3 properties such as
length or amino acid utilization they are derived from
synthetic repertoires drawn from the above pre-selection
distribution
We want to infer the parameters qL qVJ and qiL of
the model from the observed coding sequence repertoires
Formally we want to maximize the likelihood of the data
given the model Unfortunately the sequence reads from
the data are not long enough to fully specify the V and
J segments so we cannot use Ppostcid126  V J as our raw
likelihood Instead we need to write the probability of
observing a given truncated read cid126 of length 60 or 101
aCDR3sequence read 60 or 100 nt  VJdata sequencesgenerated sequences V and J are knownM11N  1MV1VMJ1JM1Nwhich parametrizes how the average is done over the hid-
den variables constant After each maximization step we
substitute
cid48
Q  argmaxQcid48 LQ
and iterate until convergence This procedure is guaran-
teed to nd a local maximum of the likelihood LQ
3 Equivalence with tting marginal probabilities
The expectation-maximization step can be simplied
by noting that at the maximum derivatives vanish
 LQcid48
Qcid48
and set them to zero
Precisely we take derivatives with each of the param-
eters qL qV J etc
Ppostcid126  V J is naturally factorized in the Q parameters
L  0 gives
we obtain simple expressions eg  L log qcid48
Ncid88
cid88
cid18
cid19
PpostVa Jacid126a Q
LaL 
 log Z
 log qcid48
V aJ a
where ab is Kroneckers delta function The term in the
sum gives the total number of sequences in the data with
length L Besides we have
cid48
Lcid126 LPpostcid126  V J Q
cid48
  PpostL Q
cid88
cid126 VJ
 log Z
 log qcid48
Hence the maximality condition simply becomes
cid48
PdataL  PpostL Q
ie that the length distribution of the model must be
equal to that of the data Similarly maximizing with
respect to qiLai entails that single amino-acid frequen-
cies at a given position are matched between data and
cid48
PiLdataai  PiLpostai Q
The condition for qV J is slightly dierent because we do
not directly have the frequencies of V and J in the data
This is replaced by their expected frequency under the
posterior PpostVa Jacid126a taken with parameters Q
Ncid88
cid48
PpostV Jcid126a Q  PpostV J Q
cid48
PpostL Q
where again the left-hand side is the empirical distribu-
tion of V and J indirectly estimated with the help of the
model with parameters Q and the right-hand side is the
model distribution of the same quantities estimated with
and similar expressions give estimates of PiLpostai Qcid48
and PpostV J Qcid48 Since we are optimizing over Qcid48 the
sequences cid126b Vb Jb can be generated once and for all at
5 Numerical implementation
parameters Qcid48 which are then varied to achieve equal-
ity with the data estimate The approach of iteratively
adjusting model parameters to match a corresponding
set of data marginals is a conceptually clear and com-
putationally eective implementation of the expectation
maximization algorithm
4 Gauge
As dened above the model is degenerate
for each
i L the factors qiLa and Z may be multiplied by a
common constant without aecting the model We need
to x a convention or gauge to lift this degeneracy We
impose that for each i L
PiLpreaqiLa  1
where PiLprea is the probability of having amino-acid
a at position i in CDR3s of length L
20cid88
To solve the tting equations C13-C15 in practice
we use a gradient descent algorithm
cid48
qL  qL   PdataL  PpostL Q
and similarly for qiL and qV J 
To do this we
must be able to calculate the marginals PpostL Qcid48
PiLpostai Qcid48 and PpostV J Qcid48 from the model at
each step
leaves us with the problem of estimating
marginals in the model which we do using importance
sampling Although it is easy to sample sequences from
Ppre by picking a random recombination scenario sam-
pling from Ppost  QPpre is much harder as the qiL qL
and qV J factors introduce complex dependencies between
the dierent features of the recombination scenario To
overcome this issue we sample a large number M of
cid126  V J triplets from Pprecid126  V J and when estimating
Ppost expectation values weight the contribution of each
sequence with its Qcid126  V J value this is a particularly
simple instance of importance sampling The generated
triplets are denoted by cid1261 V1 J1     cid126M  VM  JM 
and the corresponding reads by cid1261     cid126M  see Fig 7
for notations The marginal probability distribution of
lengths for instance is estimated by
cid80M
cid80M
b1 LbLQcid48cid126b Vb Jb
b1 Qcid48cid126b Vb Jb
FIG 8 The qiLa selection factors learned for codons red crosses agree with those learned for amino acids blue The
qiLa are plotted for each position in the CDR3 region panels from 1 to 12 for naive CDR3 sequences of length 12 as a
function of the amino acids at each position A given amino acid at a given position can come from dierent codons which are
marked by multiple crosses at that position Codons or amino acids for which there was not enough data to infer the selection
factors are not represented
FIG 9 The scatter of VJ gene selection factors qV J between donors A and B for naive A and memory repertoires B as
well as between the memory and naive repertoires of the same individual C shows that the memory and naive repertoires
are statistically similar to each other and across individuals See Fig 10 for the correlation analysis of all individuals and cell
21012Length 12 naive sequences  position1amino acidcodonsposition2position321012logqiLaposition4position5position621012position7position8position9ARNDCQEGHILKMFPSTWYV21012position10ARNDCQEGHILKMFPSTWYV Amino Acidposition11ARNDCQEGHILKMFPSTWYVposition12102100102102100102qVJ ind A naiveqVJ ind B naive102100102102100102qVJ ind A memoryqVJ ind B memory102100102102100102qVJ ind A naiveqVJ ind A memory12
FIG 11 The eects of selection on deletion proles Distribu-
tion of V A D left-hand side B D right-hand side C
and J D deletions in the pre-selected black lin e naive
colored line and memory gray dashed line repertoires Er-
ror bars show standard deviation over 9 individuals Results
using 9 separate models learned for each of the individuals
The deletion distributions for the memory repertoire are the
same as for the naive repertoire Selection has a slight eect
on favoring distributions with non-extreme deletion values of
deletions for V and J deletions and does not have a signi-
cant eect on D deletions
cid88
cid126 VJ
Eqs C13-C15 while minimizing the divergence or rel-
ative entropy with respect to Ppre dened as
DKLPpostcid107Ppre 
Ppostcid126  V J log
Ppostcid126  V J
Pprecid126  V J
Solving this problem is mathematically equivalent
to solving the maximum likelihood problem described
Appendix D Individual universal and shued
We partition the data in three dierent ways to learn
the model First we learn a distinct model for each
donor and for each of the naive and memory pools For
each donor we have a distinct Ppre learned from the out-
of-frame sequences of that donor although in fact they
dier little from donor to donor as discussed in 1 Sec-
ond we pool all the sequences of a given type naive
or memory from all nine donors together and learn a
universal or average model For this we use a mean
Ppre averaged over all nine donors and then learn Q us-
ing all sequences Third to assess the eect of nite-size
sampling in the universal model we partition the data
from all donors into nine random subsamples of equal
sizes This way we can estimate how much variability
one should expect from just sampling noise
FIG 10 Correlation coecients between selection factors ob-
tained for models learned for dierent donors and cell type
naive and memory The compared factors are the amino-
acid selection factors qiL A and the VJ gene selection fac-
tors qV J B Each position along the two axes in each plot
corresponds to a dierent individual The naive dataset of
donor 8 and the memory dataset of donor 5 were removed
because of too low statistics In all heat maps the x and y
axes correspond to dierent donors 1-79 for naive 1-46-9
for memory and 1234679 for comparison between naive
and memory
the beginning of the algorithm Then the marginal prob-
abilities are updated according to the modied Qcid48 using
Eq C18 Finally the normalization constant is evaluated
by calculating
Mcid88
Lbcid89
qLb qVbJb
qiLb ab
so thatcid88
cid126 VJ
Ppostcid126  V J 
Mcid88
Qcid126b Vb Jb  1
6 Equivalence with minimum discriminatory
information
The principle of minimum discriminatory information
is to look for a distribution that reproduces exactly some
mean observables of the data such as position-dependent
amino-acid frequencies while being minimally biased
with respect to some background distribution When
the background distribution is uniform this principle is
equivalent to the principle of maximum entropy
Taking Ppre as our background distribution assume
we are looking for the distribution Ppost that satises
naivenaivememorymemorynaivememoryshu edshu edL8L9L10L11L12L13L14L15 naivenaivememorymemorynaivememoryshu edshu ed0020406081B Correlation coecid127cients of                    between datasets A Correlation coecid127cients of                          between datasets logqVJlogqiLa0510152000050101502Number of V deletionsProbability  preselectionnaivememory0510152000050101502Number of left D deletionsProbability  preselectionnaivememory0510152000050101502Number of right D deletionsProbability  preselectionnaivememory0510152000050101502Number of J deletionsProbability  preselectionnaivememoryAppendix E Entropy distributions of Ppre Ppost and
To estimate global statistics such as entropy from the
model we draw a large set of sequences cid1261         cid126M 
from Ppre and weight them according to the inferred
normalized Q values Specically for each generated
sequence we estimate its primitive generation probabil-
ity by summing over all the possible scenarios that could
have given rise to it
Pprecid126b 
pcoding
Sb
PpreS
cid88
where cid126b is the full nucleotide sequence including the
CDR3 cid126b as well as the Vb and Jb segments The entropy
in bits of the selected sequence repertoire is dened as
HPpost  
Ppostcid126 log2 Ppostcid126
cid88
cid126
cid105
cid104
cid104
and to include selection eects we estimate it by
Mcid88
Mcid88
HPpost  
Qcid126b Vb Jb log
Qcid126b Vb JbPprecid126b
The distributions of Ppre Ppost and Q over the selected
sequences are determined from the same draw of M se-
quences from Ppre weighted by the normalized selection
factors Q For example the distribution of log Ppre is
Plog Ppre 
Qcid126b Vb Jb
log Ppre  log Pprecid126b
Marginal distributions over pairs of amino-acids
ai aj at two positions i and j can also be calculated
using the cid126b sequences and weighting them with Q This
can be generalized to arbitrary marginals or statistics
cid105
FIG 12 The saturation of the PdataQPpreQ ratio does
not aect the inference of the model We simulated a
dataset from Ppre and selected sequences with probability
minQcid1267 1 The plot compares the qiLa selection fac-
tors directly inferred from data ordinate to values inferred
from such simulated data blue dots simulation The scat-
ter in these points is compared to the scatter obtained from
learning the selection factors using a random subset of the
data red dots sample The size of the points denotes the
probability Pildataa in the data repertoire
If we assume private models the expected number of
shared sequences between donors  and  is
cid88
cid126
Appendix F Shared sequences
postcid126P 
postcid126
The number of shared sequences in a subset of donors
is counted based on the nucleotide sequences This em-
pirical number can then be compared to two kinds of
theoretical predictions Either by assuming that the se-
quences of each donor were generated and selected by a
private model P 
post where  denotes the donor ie a
model inferred from the sequences of donor  or by as-
suming that sequences were generated and selected by a
common or universal model P u
post inferred from all se-
quences together The latter is justied by the fact that
dierences between private models are small and could
reect spurious noise that would exaggerate dierences
between individuals
where N and N are the numbers of sequences in each
donor dataset To estimate that number we collect se-
quences that are shared between the generated datasets
cid126a of two or more donors and reweight them by Q
Qcid126 V JQcid126 V J
cid88
cid126VJ
where M and M are the number of generated sequences
for each donor model and where the sum is over the se-
quences found in the cid126a dataset of both donors Similar
equations are used for comparing more than two donors
321012345321012345logqiL  universal donorlogqiL  simulationsample14
FIG 13 Correlation of the qiL selection factors with several biochemical properties Each panel shows the histogram over all
positions and lengths of Spearmans correlation coecient between the qiLa values for a given amino acid and the biochemical
properties of that amino acid The following biochemical properties are considered from left to right top to bottom preference
to appear in alpha helices A beta sheets B turns C source for A-C Table 33 17 Residues that are exposed to solvent
in protein-protein complexes following denitions and data from 18 are divided intothree groups surface interface residues
that have unchanged accessibility area when the interaction partner is present D rim interface residues that have changed
accessibility area but no atoms with zero accessibility in the complex E and core interface residues that have changed acces-
sibility area and at least one atom with zero accessibility in the complex F Rim residues roughly correspond to the periphery
of the interface region and core residues correspond to the center Finally we plot the basic biochemical amino acid proper-
ties source httpenwikipediaorgwikiAmino acid and httpenwikipediaorgwikiProteinogenic amino acid
charge G pH H polarity I hydrophobicity J and volume K For all properties the actual numerical values used to
calculate the correlations are listed in the inset tables We see a positive correlation trend with turns and core residues and a
negative correlation trend with the preference of amino acids to appear in alpha helices and volume
ACCqiLaalphaaA129L130R096K123N090M147D104F107C111P052Q127S082E144T082G056W099H122Y072I097V091BCCqiLabetaaA090L102R099K077N076M097D072F132C074P064Q080S095E075T121G092W114H108Y125I145V149CCCqiLaturnaA078L059R088K096N128M039D141F058C080P191Q097S133E100T103G164W075H069Y105I051V047DCCqiLasurfaceaA0065L0063R0059K0080N0053M0016D0074F0029C0015P0054Q0051S0071E0089T0065G0070W0012H0025Y0033I0035V0048ECCqiLarimaA0047L0052R0068K0105N0062M0017D0071F0021C0015P0052Q0053S0072E0094T0064G0071W0007H0022Y0032I0032V0048FCCqiLacoreaA0049L0078R0066K0050N0058M0027D0051F0051C0020P0051Q0051S0057E0051T0064G0060W0022H0034Y0070I0047V0049Fraction of positionsGCCqiLachargeaA0L0R1K1N0M0D-1F0C0P0Q0S0E-1T0G0W0H0Y0I0V0HCCqiLapHaA0L0R2K2N0M0D-2F0C-2P0Q1S-1E-2T-1G0W1H1Y-1I0V005005ICCqiLapolaraA0L0R1K1N1M0D1F0C0P0Q1S1E1T0G0W1H1Y1I0V005005JCCqiLahydropaA18L38R-45K-39N-35M19D-35F28C25P-16Q-35S-08E-35T-07G-04W-09H-32Y-13I45V4205005Spearmans correlationKCCqiLavolumeaA67L124R148K135N96M124D91F135C86P90Q114S73E109T93G48W163H118Y141I124V10515
FIG 14 Model prediction magenta and observed red dis-
tributions of Ppost in the naive sequences that are shared be-
tween at least three left or four right donors The model
discrepancy may be attributed to its failure to capture the
very highly probable sequences
If we assume a common model the expected number
of shared sequences reads
postcid1262
cid88
cid126
This can be estimated by
Mcid88
pre cid126bQucid126b Vb Jb2
where cid126a are sequences generated from the mean VDJ
recombination model P u
pre  Similarly the number of
shared sequences between a triplet of donors    is
pre cid126b2Qucid126b Vb Jb3
Mcid88
NNN
and likewise for quadruplets and more
The expected numbers of shared sequences calculated
above are averages Their distribution is given by a Pois-
son distribution of the same mean We use these Poisson
distribution to estimate the error bars in Fig 6A and
15A as well as the distributions in Fig 6B-C and S15B-
If we assume a common model sequences that are
shared between at least n individuals are distributed ac-
cording to  P u
postn To explore the statistics of these
sequences we take our cid126b sequences generated from P u
pre cid126bn1Qucid126bn For ex-
and weigh them with P u
ample to estimate the distribution of log Ppost in shared
sequences as in Fig 6D for pairs and Fig 14 for
triplets and quadruplets we calculate
Plog Ppost 
pre cid126bn1Qucid126b Vb Jbn
Mcid88
cid104
log Ppost  log P u
cid105
postcid126b
FIG 15 Comparison between data and model for the number
of shared sequences in the memory repertoires in pairs A
triplets B and quadruplets C of individuals
Sampling from shared sequences is equivalent to sam-
pling from the high-probability large deviation regime of
the distribution This statement can be made more phys-
ically intuitive by rewriting Ppost as a Boltzmann distri-
bution eET with T  1 and E   log Ppost Consider-
ing sequences observed in at least n donors is equivalent
to sampling from 1ZnenE where Zn is a normal-
isation constant ie the Boltzmann distribution with
T  1n Sequences shared between more and more in-
dividuals correspond to lower and lower temperatures
and thus lower energies and higher probabilities In the
low temperature regime the roughness of the landscape
depicted in Fig 4C is starting to become important and
may not be well captured by our model as suggested by
Fig 14
Appendix G Codon model
It is reasonable to assume that selection acts on the
protein structure at the amino acid level But each
amino acid can be obtained using a number of dier-
ent codons which could in principle each have a dier-
ent selection factor We checked the robustness of our
selection coecients by learning an alternative model in
which selection acts on codons We present the results
of this alternative codon model in Fig 8 on the example
of CDR3 sequences of length 12 We show the qiLa se-
lection factors at each position for each amino acid and
compare them to the selection factors obtained for the
codons coding for that amino acid We see that espe-
2520151050020406081log10 PpostDensity  prepost predicteddatashared in tripletspredictionshared in tripletdata1510501234log10 PpostDensity  prepost predicteddatashared in quadrupletspredictionshared in quadrupletsdata01002003004005000100200300400500Shared sequences between pairsModel prediction  Common modelPrivate models010200051Shared sequences between tripletFrequency  ObservedCommon ModelPrivate Models01234560051Sequences between quadrupletsFrequency  ObservedCommon ModelPrivate ModelsACBcially in the bulk of the CDR3 sequence selection at the
level of codons or amino acids are equivalent proving the
generality of our approach
Appendix I Eects of saturation of global selection
factors on the inference procedure
Appendix H Additional eects of selection on
repertoire properties
In the main text we present several repertoire prop-
erties such as insertion proles and comparisons of
the qiLa selection factors between naive and memory
repertoires In Fig 11 we plot the deletion proles for
V  J and D-lefthand side and D-righthand side dele-
tions comparing the distributions for the pre-selection
naive and memory repertoires We note that the deletion
proles for the V and J distributions are more peaked
favoring intermediate deletion values However the D dis-
tributions are little aected by selection Similarly to the
case of insertion distributions shown in in Fig 3E-F the
naive and memory distributions appear indistinguishable
within the error bars
In Fig 3A-C the selection factors qiLa acting on
amino acids are compared between individuals and cell
type Similarly the selection factors acting on the genes
qV J are statistically indistinguishable between the mem-
ory and naive repertoires for one individual compared to
the variability between the naive or memory repertoires
taken from two sample individuals see Fig 9
To compare the repertoires of individuals as well as
the naive and memory repertoires with each other we
consider the correlation coecients between the selec-
tion factors log qiL and between the VJ gene selection
factor log qV J  of dierent individuals Fig 10 Correla-
tions between memory and naive repertoires are similar
to those between naive-naive or memory-memory reper-
toires for dierent individuals all are a bit smaller than
the correlations between the articial shued sequence
datasets where the discrepancy is entirely attributable
to statistical noise These observations lead us to the
conclusion that at this level of description the selection
processes that shape the memory and naive repertoires
are very similar with each other and between dierent
individuals
We consider distributions of the selection factor Q in
the pre-selection ensemble PpreQ in the post-selection
ensemble according to the model PpostQ and in the ac-
tual data sequences PdataQ These three distributions
are formally dened as
PpreQ 
PpostQ 
Mcid88
Mcid88
Ncid88
cid2Q  Qcid126b Vb Jbcid3 
Qcid126b Vb Jbcid2Q  Qcid126b Vb Jbcid3I2
cid88
 QPpreQ
PdataQ 
PpostVa Jacid126a
 Q  Qcid126 a Va Ja
As can be seen in Fig 4 the ratio of the distribution
of global selection factors PdataQPpreQ saturates for
large values of Q To make sure that this saturation
does not impair our ability to correctly infer the selection
factors we simulated a dataset from Ppre and selected
sequences with probability minQcid1267 1 to mimic the
eects of this plateau We then inferred the selection
coecients for this articial dataset We see that the
saturation does not aect our ability to correctly infer
the selection coecients Fig 12 and the variability in
the inferred qiLa selection factors is of the same order
as from using random subsamples of the original data
Appendix J Biochemical correlations
To check for correlations of our inferred qiLa selec-
tion factors with known biochemical properties we calcu-
lated Spearmans coecient between the selection factors
and a number of standard quantities see Fig 13 for the
full list We nd that the selection factors do not corre-
late well with most standard properties such as charge
hydrophobicity and polarity However we do nd a trend
of positive correlation with amino acids that are likely
to appear in turns Fig 13 C and ones that have been
identied as those that make the core of the interface
in a protein-protein complexes Fig 13 F 18 We nd
a trend of negative correlations with amino acids that
have large volume Fig 13 K and are likely to appear in
alpha helices Fig 13 A These observations are consis-
tent with the fact that structurally CDR3 regions form
loops and bulky amino acids as well as stabilizing alpha
helix-like interactions would interfere with this structure
Core amino acids are at the center of the interface and
are known to be the main contributors to interface recog-
nition and anity On the other hand interface rim and
non-interface surface residues which are both in touch
to various degrees with the solvent and are not crucial
interface forming elements show similar non-distinctive
correlation patterns
1 Murugan A Mora T Walczak AM Callan CG 2012
Statistical inference of the generation probability of t-cell
receptors from sequence repertoires Proceedings of the
National Academy of Sciences 1091616116166
2 Janeway C 2005 Immunobiology the immune system
in health and disease Garland Pub
3 Weinstein JA Jiang N White RA Fisher DS Quake
SR 2009 High-throughput sequencing of the zebrash
antibody repertoire Science 32480710
4 Ndifon W et al 2012 Chromatin conformation governs
t-cell receptor j gene segment usage Proc Natl Acad Sci
USA 1091586570
5 Mora T Walczak AM Bialek W Callan CG 2010 Max-
imum entropy models for antibody diversity Proceedings
of the National Academy of Sciences of the United States
of America 10754055410
6 Quigley MF et al
2010 Convergent recombination
shapes the clonotypic landscape of the naive t-cell reper-
toire Proc Natl Acad Sci USA 107194149
7 Venturi V Price DA Douek DC Davenport MP 2008
The molecular basis for public t-cell responses Nat Rev
Immunol 82318
8 Baum PD Venturi V Price DA 2012 Wrestling with
the repertoire The promise and perils of next genera-
tion sequencing for antigen receptors Eur J Immunol
4228342839
9 Six A et al
2013 The past present and future of
immune repertoire biology  the rise of next-generation
repertoire analysis Front Immunol 4116
10 Robins H 2013 Immunosequencing applications of im-
mune repertoire deep sequencing Current Opinion in
Immunology 2564652
11 Yates AJ 2014 Theories and quantication of thymic
selection Front Immunol 513
12 Jameson SC 2002 Maintaining the norm T-cell home-
ostasis Nature Reviews Immunology 254756
13 Detours V Mehr R Perelson AS 1999 A quantita-
tive theory of anity-driven t cell repertoire selection J
Theor Biol 200389403
14 Kosmrlj A Jha AK Huseby ES Kardar M Chakraborty
AK 2008 How the thymus designs antigen-specic and
self-tolerant t cell receptor sequences Proc Natl Acad Sci
USA 105166716
15 Robins HS et al 2009 Comprehensive assessment of
T-cell receptor beta-chain diversity in alphabeta T cells
Blood 11440994107
16 Robins H et al 2010 Overlap and eective size of the
human CD8 T cell receptor repertoire Science trans-
lational medicine 247ra64
17 Stryer L Berg JM Tymoczko JL 2002 Biochemistry
5th edition WH Freeman  Co Ltd Vol 5th edition
18 Martin J Lavery R 2012 Arbitrary protein-protein
docking targets biologically relevant interfaces BMC
Biophysics 17
19 Mustonen V Lassig M 2005 Evolutionary population
genetics of promoters predicting binding sites and func-
tional phylogenies Proc Natl Acad Sci USA 10215936
20 Mustonen V Kinney J Callan CG Lassig M 2008
Energy-dependent tness a quantitative model for the
evolution of yeast transcription factor binding sites Proc
Natl Acad Sci USA 1051237681
21 Venturi V et al
2006 Sharing of t cell receptors in
antigen-specic responses is driven by convergent recom-
bination Proc Natl Acad Sci USA 103186916
22 Wang C et al 2010 High throughput sequencing re-
veals a complex pattern of dynamic interrelationships
among human t cell subsets Proc Natl Acad Sci USA
107151823
23 Robins HS et al 2010 Overlap and eective size of the
human CD8 T cell receptor repertoire Science trans-
lational medicine 247ra64
24 Monod MY Giudicelli V Chaume D Lefranc MP 2004
IMGTJunctionAnalysis the rst tool for the analysis of
the immunoglobulin and T cell receptor complex V-J and
V-D-J JUNCTIONs Bioinformatics 20i379i385
25 Dempster A Laird N Rubin D 1977 Maximum likeli-
hood from incomplete data via the EM algorithm Jour-
nal of the Royal Statistical Society Series B 39138
26 McLachlan GJ Krishnan T 2008 The EM Algorithm
and Extensions Wiley Series in Probability and Statis-
tics Wiley-Interscience 2 edition
